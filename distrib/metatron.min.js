/*
 *  MetatronJS
 *  Javascript UI library that helps you create your own custom workflow designers
 *  Version: 1.0.0
 *  Author: SMAKALANDE (GTO - VirtusaPolaris)
 *
 *    Copyright 2017 VirtusaPolaris.
 *
 *    Licensed under the Apache License, Version 2.0 (the "License");
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an "AS IS" BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */


!function(a){"undefined"==typeof Metatron?a.Metatron=function(){var a={};return a.EventAPI,a.DrawingBoard,a.EntityStore,a.CommandExecuter,a.Commands,a.Util,a.create=function(b,c,d){function e(){f.drawingBoard=new a.DrawingBoard(f,b,c),f.entityStore=new a.EntityStore(f,c),f.commandExecuter=new a.CommandExecuter(f),f.commands=new a.Commands(f),f.util=new a.Util(f)}var f={containerId:b,stencilBoxConfig:c,editMode:d,eventAPI:new a.EventAPI,drawingBoard:{},entityStore:{},commandExecuter:{},usableMargin:500,gridSpacing:15,showGrid:!1,instancePaper:{},instanceStencilUsage:{},menubarGraphicSet:null,instanceMenubarElement:{},observerModeMenuItems:[],editModeMenuItems:[]},g={reload:function(){e()},extract:function(){return JSON.stringify(f.entityStore.extract())},load:function(a){e();try{f.entityStore.load(JSON.parse(a))}catch(a){console.log(a),this.reload()}},enableEditMode:function(){var a=this.extract();f.editMode=!0,this.load(a)},disableEditMode:function(){var a=this.extract();f.editMode=!1,this.load(a)},on:function(a,b){f.eventAPI.on(a,b)},addIndicator:function(a,b){f.drawingBoard.addIndicator(f.entityStore.getComponent(a),b)},removeIndicator:function(a,b){f.drawingBoard.removeIndicator(f.entityStore.getComponent(a),b)},removeIndicators:function(a){if(a){var b=f.entityStore.getComponent(a);f.drawingBoard.removeIndicators(b)}else f.drawingBoard.clearAllIndicators()},renameComponent:function(a,b){var c=f.entityStore.getComponent(a);c&&f.commandExecuter.execute(new f.commands.RenameComponentCommand({component:c,newName:b,oldName:c.displayName}),!0)},toggleIndicator:function(a,b){f.drawingBoard.toggleIndicator(f.entityStore.getComponent(a),b)},deleteSelection:function(){f.drawingBoard.deleteSelection()},blockUI:function(){f.drawingBoard.blockUI()},unblockUI:function(){f.drawingBoard.unblockUI()},getMenu:function(a){return f.drawingBoard.getMenu(a)},setMenu:function(a,b){f.drawingBoard.setMenu(a,b)},addMenuItem:function(a,b){f.drawingBoard.addMenuItem(a,b)},addComponent:function(a){f.entityStore.addComponent(a,!1)},undo:function(){f.commandExecuter.undo()},redo:function(){f.commandExecuter.redo()},showGrid:function(a){var b=this.extract();f.showGrid=!0,this.load(b)},hideGrid:function(){var a=this.extract();f.showGrid=!1,this.load(a)}};return e(),g},a}():console.error("Metatron has already been defined")}(window),function(a){a.EventAPI=function(){this.EVT_SAVE="save",this.EVT_CMP_CLICK="componentClick",this.EVT_CON_CLICK="connectionClick",this.EVT_CMP_DBL_CLICK="componentDblClick",this.EVT_EXEC_COMMAND="executeCommand",this.EVT_UNDO_COMMAND="undoCommand",this.EVT_REDO_COMMAND="redoCommand",this.EVT_CANVAS_CLICK="canvasClick",this.EVT_VALIDATION_FAILED="validationFailed",this.eventFunctions={},this.on=function(a,b){this.eventFunctions[a]=b},this.getFunction=function(a){return this.eventFunctions[a]?this.eventFunctions[a]:function(){}}}}(Metatron),function(a){a.EntityStore=function(a,b){this.componentIdPrefix="cmp_",this.connectionIdPrefix="con_",this.entityCount=0,this.stencilBoxConfig=b,this.components={},this.connections={},this.getStencilConfig=function(a){for(var b=0;b<this.stencilBoxConfig.stencils.length;b++)if(this.stencilBoxConfig.stencils[b].id===a)return this.stencilBoxConfig.stencils[b]},this.getNextComponentId=function(){var a=this.componentIdPrefix+this.entityCount++;return this.getComponent(a)?this.getNextComponentId():a},this.addComponent=function(b,c){var d=a.entityStore.getStencilConfig(b.stencilId);if(!d.componentLimit||a.instanceStencilUsage[d.id]!==d.componentLimit)return b.id||(b.id=this.getNextComponentId()),b.type="component",a.commandExecuter.execute(new a.commands.AddComponentCommand({component:b}),void 0===c||c);console.log("Could Not Add Component: Limit Reached ["+d.name+"]")},this.getComponent=function(a){return this.components[a]},this.removeComponent=function(b){var c=a.entityStore.getStencilConfig(b.stencilId);c.nonRemovable?console.log("Could Not Remove Component: Non-Removable ["+c.name+"]"):a.commandExecuter.execute(new a.commands.RemoveComponentCommand({component:b}),!0)},this.addConnection=function(b){b.id=this.connectionIdPrefix+b.fromComponentId+b.fromPlacement+"_"+b.toComponentId+b.toPlacement,b.type="connection",a.commandExecuter.execute(new a.commands.AddConnectionCommand({connection:b,animate:!0}),!0)},this.changeConnectionType=function(b,c){a.commandExecuter.execute(new a.commands.ChangeConnectionCommand({connection:b,newConnectionType:c,oldConnectionType:b.connectionType}),!0)},this.getConnection=function(a){return this.connections[a]},this.removeConnection=function(b){a.commandExecuter.execute(new a.commands.RemoveConnectionCommand({connection:b,animate:!0}),!0)},this.extract=function(){var a=$.extend(!0,{},this.components),b=[];for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];delete d.element,delete d.labelElement;for(var e=0;e<d.inboundConnections.length;e++)delete d.inboundConnections[e].element,d.inboundConnections[e].labelElement&&(delete d.inboundConnections[e].labelElement,delete d.inboundConnections[e].labelBackgroundElement);for(var e=0;e<d.outboundConnections.length;e++)delete d.outboundConnections[e].element,d.outboundConnections[e].labelElement&&(delete d.outboundConnections[e].labelElement,delete d.outboundConnections[e].labelBackgroundElement);b.push(a[c])}return b},this.load=function(b){this.components={},this.connections={};for(var c=0;c<b.length;c++)a.commandExecuter.execute(new a.commands.AddComponentCommand({component:b[c]}),!1),this.entityCount++;this.validate()},this.validate=function(){var b=!1,c="Metatron Validation Failed! \n",d={missingComponents:[],componentsWithInvalidInConnections:[],componentsWithInvalidOutConnections:[]};for(var e in this.connections)if(this.connections.hasOwnProperty(e)){var f=this.connections[e].fromComponentId,g=this.connections[e].toComponentId;this.getComponent(f)||(c+=f+" is missing, but there is a connection from it to "+g+"\n",-1===d.missingComponents.indexOf(f)&&d.missingComponents.push(f),-1===d.componentsWithInvalidInConnections.indexOf(g)&&d.componentsWithInvalidInConnections.push(g),b=!0),this.getComponent(g)||(c+=g+" is missing, but there is a connection to it from "+f+"\n",-1===d.missingComponents.indexOf(g)&&d.missingComponents.push(g),-1===d.componentsWithInvalidOutConnections.indexOf(f)&&d.componentsWithInvalidOutConnections.push(f),b=!0)}if(b)throw a.eventAPI.getFunction(a.eventAPI.EVT_VALIDATION_FAILED)({message:c,data:d}),c}}}(Metatron),function(a){a.CommandExecuter=function(a){this.executedCommandStack=[],this.undoCommandStack=[],this.execute=function(b,c){var d=b.execute($.extend(!0,{},b.params));return c&&(this.executedCommandStack.push(b),this.undoCommandStack=[]),a.eventAPI.getFunction(a.eventAPI.EVT_EXEC_COMMAND)($.extend(!0,{},b),!c),d},this.undo=function(){if(this.executedCommandStack.length>0){a.drawingBoard.deselectAll();var b=this.executedCommandStack.pop();b.undo($.extend(!0,{},b.params)),this.undoCommandStack.push(b),a.eventAPI.getFunction(a.eventAPI.EVT_UNDO_COMMAND)($.extend(!0,{},b))}},this.redo=function(){if(this.undoCommandStack.length>0){a.drawingBoard.deselectAll();var b=this.undoCommandStack.pop();b.execute($.extend(!0,{},b.params)),this.executedCommandStack.push(b),a.eventAPI.getFunction(a.eventAPI.EVT_REDO_COMMAND)($.extend(!0,{},b))}}}}(Metatron),function(a){var b=function(a,b,c,d){this.name=a,this.execute=b,this.undo=c,this.params=$.extend(!0,{},d)};a.Commands=function(a){var c={AddComponentCommand:function(a){return new b("Add Component",function(a){return d(a)},function(a){e(a)},a)},RemoveComponentCommand:function(a){return new b("Remove Component",function(a){e(a)},function(a){d(a)},a)},MoveComponentCommand:function(a){return new b("Move Component",function(a){f(a,!1)},function(a){f(a,!0)},a)},RenameComponentCommand:function(a){return new b("Rename Component",function(a){g(a,!1)},function(a){g(a,!0)},a)},AddConnectionCommand:function(a){return new b("Add Connection",function(a){h(a)},function(a){i(a)},a)},RemoveConnectionCommand:function(a){return new b("Remove Connection",function(a){i(a)},function(a){h(a)},a)},ChangeConnectionCommand:function(a){return new b("Change Connection",function(a){j(a,!1)},function(a){j(a,!0)},a)}},d=function(b){var d=b.component,e=a.entityStore.components[d.id]=d,f=$.extend(!0,[],d.inboundConnections),g=$.extend(!0,[],d.outboundConnections);e.element=a.drawingBoard.drawComponent(e);for(var h=0;h<f.length;h++)a.commandExecuter.execute(new c.AddConnectionCommand({connection:f[h],animate:!0}),!1);for(var h=0;h<g.length;h++)a.commandExecuter.execute(new c.AddConnectionCommand({connection:g[h],animate:!0}),!1);return e},e=function(b){var d=b.component,e=a.entityStore.getComponent(d.id),f=$.extend(!0,[],d.inboundConnections),g=$.extend(!0,[],d.outboundConnections);a.drawingBoard.eraseComponent(e);for(var h=0;h<f.length;h++)a.commandExecuter.execute(new c.RemoveConnectionCommand({connection:f[h],animate:!0}),!1);for(var h=0;h<g.length;h++)a.commandExecuter.execute(new c.RemoveConnectionCommand({connection:g[h],animate:!0}),!1);delete a.entityStore.components[d.id]},f=function(b,c){var d=b.component,e=a.entityStore.getComponent(d.id),f=b.displacement;e.position=a.drawingBoard.drawComponentMovement(e,f,c),e.element.drawConnectingPoints(e),a.drawingBoard.drawConnectors(e,!1)},g=function(b,c){var d=b.component,e=a.entityStore.getComponent(d.id);e.displayName=c?b.oldName:b.newName,a.drawingBoard.drawComponentLabel(e)},h=function(b){var c=b.connection,d=a.entityStore.connections[c.id]=c,e=a.entityStore.getComponent(c.fromComponentId),f=a.entityStore.getComponent(c.toComponentId);if(e&&f&&a.drawingBoard.drawConnector(d,b.animate),e){for(var g=0;g<e.outboundConnections.length;g++)if(c.id===e.outboundConnections[g].id){e.outboundConnections.splice(g,1);break}e.outboundConnections.push(d)}if(f){for(var g=0;g<f.inboundConnections.length;g++)if(c.id===f.inboundConnections[g].id){f.inboundConnections.splice(g,1);break}f.inboundConnections.push(d)}return d},i=function(b){var c=b.connection,d=a.entityStore.getConnection(c.id);a.drawingBoard.eraseConnector(d);for(var e=a.entityStore.getComponent(c.fromComponentId),f=0;f<e.outboundConnections.length;f++)if(e.outboundConnections[f].id===c.id){e.outboundConnections.splice(f,1);break}for(var g=a.entityStore.getComponent(c.toComponentId),f=0;f<g.inboundConnections.length;f++)if(g.inboundConnections[f].id===c.id){g.inboundConnections.splice(f,1);break}delete d},j=function(b,d){var e=b.connection,f=a.entityStore.getConnection(e.id);e.connectionType=d?b.oldConnectionType:b.newConnectionType,a.commandExecuter.execute(new c.RemoveConnectionCommand({connection:f,animate:!1}),!1),a.commandExecuter.execute(new c.AddConnectionCommand({connection:e,animate:!1}),!1)};return c}}(Metatron),function(a){a.DrawingBoard=function(a,b,c){function d(){P.css("overflow","hidden"),P.css("height",P.height()),P.css("width",P.width())}function e(){P.prepend('<style type="text/css"> @font-face {font-family:"Roboto-Regular"; src: url("scp-metatron/fonts/Roboto-Regular.ttf");</style>')}function f(){var a=b+"_toolbox",c=$("<div>");return c.addClass("toolbox"),c.attr("id",a),c.css("float","left"),c.css("background-color","#F9F9F9"),c.css("border","1px solid #E3E3E3"),c.css("width",R),c.css("height",P.height()-2),P.append(c),c}function g(){var a=b+"_menubar",c=$("<div>");return c.addClass("menubar"),c.attr("id",a),c.css("float","left"),c.css("background-color","#F9F9F9"),c.css("border","1px solid #E3E3E3"),c.css("width",P.width()-R-4),c.css("height",S),P.append(c),c}function h(){var a=b+"_workspace",c=$("<div>");return c.addClass("workspace"),c.attr("id",a),c.css("float","left"),c.css("overflow","hidden"),c.css("background-color","#F9F9F9"),c.css("border","1px solid #E3E3E3"),c.css("width",P.width()-R-4),c.css("height",P.height()-S-4),P.append(c),c}function i(a){var b=$("<div>");b.text("Toolbox"),b.css("font-family","Roboto-Regular"),b.css("font-size",13),b.css("color","#aaa"),b.css("margin-top",10),b.css("margin-left",10),b.css("margin-bottom",40),a.append(b);for(var d=0;d<c.stencils.length;d++)if(!c.stencils[d].hidden){var e=$("<div>");e.addClass("stencil"),e.css("width",R-2),e.css("height",W),e.css("margin-bottom",6),a.append(e);var f=$("<div>");f.css("width",V),f.css("height",W),f.css("float","left"),f.css("margin-left",10),f.css("background-image",'url("'+c.stencils[d].imgPath+'")'),f.attr("draggable","true"),f.attr("stencilId",c.stencils[d].id),f.css("cursor","move"),f.bind("dragstart",function(a){a.stencilId=$(this).attr("stencilId"),stencilDragEvent=a}),e.append(f);var g=$("<div>");g.text(c.stencils[d].name),f.css("float","left"),g.css("width","auto"),g.css("font-family","Roboto-Regular"),g.css("font-size",12),g.css("color","#aaa"),g.css("margin-top",6),g.css("margin-left",15),g.css("display","inline-block"),e.append(g)}}function j(b){b.html("");var c;c=a.editMode?a.editModeMenuItems:a.observerModeMenuItems;for(var d=0;d<c.length;d++){var e=$("<div>");e.css("float","left"),e.css("width",S),e.css("height",S),e.css("background-image",'url("'+c[d].icon+'")'),e.css("cursor","pointer"),e.bind("click",c[d].function),b.append(e)}}function k(c){function d(a){}a.instancePaper=Raphael(document.getElementById(c.attr("id")),P.width()-R-4,P.height()-S-4),a.instancePaper.canvas.onclick=function(b){a.eventAPI.getFunction(a.eventAPI.EVT_CANVAS_CLICK)(b)},this.workspace=a.instancePaper.rect(0,0,U+2*aa.usableMarginWidth,T+2*aa.usableMarginWidth),this.workspace.attr({stroke:"#DEE","stroke-width":7,"stroke-dasharray":"-.."}),a.showGrid&&l(),$("#"+b+"_workspace").bind("dragover",function(a){a.preventDefault()}),$("#"+b+"_workspace").bind("drop",function(b){if(b.preventDefault(),stencilDragEvent){var c=a.util.createComponent(a.entityStore.getStencilConfig(stencilDragEvent.stencilId),a.util.alignCoordinateToGrid(b.originalEvent.layerX-stencilDragEvent.originalEvent.offsetX+aa.x),a.util.alignCoordinateToGrid(b.originalEvent.layerY-stencilDragEvent.originalEvent.offsetY+aa.y));E(a.entityStore.addComponent(c)),stencilDragEvent=null}});var e,f,g,h,i,j,k=a.instancePaper,m=k.width,n=k.height,o="#"+b+"_workspace",p=!1,q=k.setViewBox(0,0,m,n);q.X=0,q.Y=0,window.addEventListener&&window.addEventListener("DOMMouseScroll",d,!1),window.onmousewheel=document.onmousewheel=d,$(o).mousedown(function(a){null===k.getElementByPoint(a.pageX,a.pageY)&&(p=!0,e=a.pageX,f=a.pageY,i=null,j=null)}),$(o).mousemove(function(a){!1!==p&&(g=e-a.pageX,h=f-a.pageY,x=m/k.width,y=n/k.height,g*=x,h*=y,q.X+g<0?(aa.x=0,i=i||g,g=i):q.X+g>2*aa.usableMarginWidth?(aa.x=2*aa.usableMarginWidth,i=i||g,g=i):aa.x=q.X+g,q.Y+h<0?(aa.y=0,j=j||h,h=j):q.Y+h>2*aa.usableMarginWidth?(aa.y=2*aa.usableMarginWidth,j=j||h,h=j):aa.y=q.Y+h,aa.width=m,aa.height=n,document.getSelection().removeAllRanges(),k.setViewBox(aa.x,aa.y,m,n))}),$(window).mouseup(function(a){!1!==p&&(q.X=aa.x,q.Y=aa.y,p=!1)})}function l(b){ca=[];for(var c=b||.6,d=4;d<U+2*aa.usableMarginWidth;d+=a.gridSpacing){var e="M "+d+",0 L ",f=e+" "+d+","+T+2*aa.usableMarginWidth,g=a.instancePaper.path(f);g.attr({"stroke-width":c,stroke:"#DEE"}),ca.push(g)}for(var d=4;d<T+2*aa.usableMarginWidth;d+=a.gridSpacing){var e="M 0,"+d+" L ",f=e+" "+U+2*aa.usableMarginWidth+","+d,g=a.instancePaper.path(f);g.attr({"stroke-width":c,stroke:"#dddddd"}),g.toBack(),ca.push(g)}}function m(){for(var a=0;a<ca.length;a++)ca[a].remove()}function n(){return a.instancePaper._vbSize||1/a.instancePaper._viewBoxShift.scale}function o(b){var c=a.instancePaper.set(),d=a.instancePaper.rect(b.position.x,b.position.y,V,W);d.workspace=this.workspace,p(b,d),c.draggable=function(){var c=function(){this.o().toFront(),this.connectingPoints&&this.drawConnectingPoints&&this.drawConnectingPoints(b),E(b)},e=function(c,e){var f=n();this.dx=c,this.dy=e;var g=this.ox+c*f,h=this.oy+e*f;g=Math.max(Math.min(g,d.workspace.getABox().topRight.x-V),d.workspace.getABox().topLeft.x),h=Math.max(Math.min(h,d.workspace.getABox().bottomRight.y-W),d.workspace.getABox().topRight.y),this.startingX||this.startingY||(this.startingX=g,this.startingY=h),g=a.util.alignCoordinateToGrid(g),h=a.util.alignCoordinateToGrid(h),this.currentX=g,this.currentY=h,N(b,{endingX:this.currentX,endingY:this.currentY,startingX:this.startingX,startingY:this.startingY}),this.connectingPoints&&this.drawConnectingPoints&&this.drawConnectingPoints(b),M(b,!1),E(b)},f=function(c){this.startingX&&this.startingY&&this.currentX&&this.currentY&&(this.startingX!==this.currentX||this.startingY!==this.currentY)&&a.commandExecuter.execute(new a.commands.MoveComponentCommand({component:b,displacement:{endingX:this.currentX,endingY:this.currentY,startingX:this.startingX,startingY:this.startingY}}),!0),delete this.currentX,delete this.currentY,delete this.startingX,delete this.startingY,E(b),3===c.which&&this.showComponentActionsMenu(b)};return this.drag(e,c,f),this},d.drawConnectingPoints=C,d.showComponentActionsMenu=q,c.drawConnectingPoints=function(a){for(var b=0,c=this.items.length;b<c;b++)this.items[b].drawConnectingPoints(a);return this},c.push(d).drawConnectingPoints(b);var e="pointer";return a.editMode&&(c.draggable(),e="move"),c.attr({fill:'url("'+a.entityStore.getStencilConfig(b.stencilId).imgPath+'")',stroke:"none",cursor:e,repeat:"none"}),c.mousedown(function(c){c.stopPropagation(),a.clickCount?a.clickCount++:(a.clickCount=1,setTimeout(function(){1===a.clickCount?a.eventAPI.getFunction(a.eventAPI.EVT_CMP_CLICK)(b):a.eventAPI.getFunction(a.eventAPI.EVT_CMP_DBL_CLICK)(b),a.clickCount=0},200))}),c.mouseup(function(){a.editMode||E(b)}),c}function p(b,c){b.labelElement&&b.labelElement.remove();var d=(a.instancePaper.set(),b.displayName),e=4.5*d.length;b.labelElement=a.instancePaper.text(c.attrs.x+W/2-e/2,c.attrs.y+W-9,d).attr({fill:"#888","font-size":10,"text-anchor":"start","font-family":"Roboto-Regular"})}function q(b){for(var c=this.getABox(),d=this.paper.set(),e=a.entityStore.getStencilConfig(b.stencilId),f=0;f<e.actions.length;f++){var g=this.paper.rect(c.topRight.x+12,c.topRight.y+17*f,68,0);g.attr({stroke:"none",fill:"#212121",opacity:.7,cursor:"pointer"});var h=Y,i=Raphael.animation({height:17},h,X);if(g.animate(i.delay(h*f)),g.mouseout(function(){this.attr({fill:"#212121"})}),g.mouseover(function(){this.attr({fill:"#303030"})}),g.mouseout(function(){this.attr({fill:"#212121"})}),g.executerFunction=e.actions[f].executerFunction,g.mousedown(function(){this.executerFunction(b)}),f<e.actions.length-1){var j=this.paper.path("M  "+(c.topRight.x+12+5)+","+(c.topRight.y+17*(f+1))+" L "+(c.topRight.x+68+12-5)+","+(c.topRight.y+17*(f+1)));j.attr({stroke:"#F1F1F1",opacity:0}),d.push(j);var k=Raphael.animation({opacity:1},0);j.animate(k.delay(h*f+.6*h))}var l=this.paper.text(c.topRight.x+12+10,c.topRight.y+17*f+8,e.actions[f].displayName).attr({"font-size":10,"text-anchor":"start",cursor:"pointer","font-family":"Roboto-Regular",opacity:0,fill:"#F1F1F1"}),m=Raphael.animation({opacity:1},0);l.animate(m.delay(h*f+.6*h)),l.menuItem=g,l.mouseover(function(){this.menuItem.attr({fill:"#303030"})}),l.mouseout(function(){this.menuItem.attr({fill:"#212121"})}),l.mousedown(function(){this.menuItem.executerFunction(b)}),d.push(g),d.push(l)}_=d}function r(b,c){for(var d=(b.element.attrs.path[0],b.element.paper.set()),e=a.entityStore.getComponent(b.fromComponentId),f=a.entityStore.getStencilConfig(e.stencilId),g=a.entityStore.getStencilConfig(f.id).outboundConnectorConfigs,h=0;h<g.length;h++){for(var i=!1,j={},k=0;k<e.outboundConnections.length;k++)j[e.outboundConnections[k].connectionType]||(j[e.outboundConnections[k].connectionType]=0),j[e.outboundConnections[k].connectionType]++;j[g[h].type]&&j[g[h].type]===g[h].maxCount&&(i=!0);var l=b.element.paper.rect(c.offsetX+12+aa.x,c.offsetY+17*h+aa.y,85,0);l.attr({stroke:"none",fill:"#212121",opacity:.7});var m=Y,n=Raphael.animation({height:17},m,X);if(l.animate(n.delay(m*h)),l.mouseout(function(){this.attr({fill:"#212121"})}),h<g.length-1){var o=b.element.paper.path("M  "+(c.offsetX+12+5+aa.x)+","+(c.offsetY+17*(h+1)+aa.y)+" L "+(c.offsetX+85+12-5+aa.x)+","+(c.offsetY+17*(h+1)+aa.y));o.attr({stroke:"#F1F1F1",opacity:0}),d.push(o);var p=Raphael.animation({opacity:1},0);o.animate(p.delay(m*h+.6*m))}var q=b.element.paper.text(c.offsetX+12+6+aa.x,c.offsetY+17*h+8+aa.y,g[h].defaultLabel?g[h].defaultLabel:g[h].type).attr({"font-size":10,"text-anchor":"start","font-family":"Roboto-Regular",opacity:0}),r=Raphael.animation({opacity:1},0);q.animate(r.delay(m*h+.6*m)),q.menuItem=l,q.mouseout(function(){this.menuItem.attr({fill:"#212121"})}),i?(l.attr({cursor:"default"}),q.attr({fill:"#898989",cursor:"default"}),q.attr({text:q.attr("text")+" [used]"})):(l.attr({cursor:"pointer"}),q.attr({cursor:"pointer",fill:"#F1F1F1"}),l.mouseover(function(){this.attr({fill:"#303030"})}),q.mouseover(function(){this.menuItem.attr({fill:"#303030"})}),l.connectionType=g[h].type,l.mousedown(function(){a.entityStore.changeConnectionType(b,this.connectionType)}),q.connectionType=g[h].type,q.mousedown(function(){a.entityStore.changeConnectionType(b,this.connectionType)})),d.push(l),d.push(q)}_=d}function s(b){if(!a.editMode)for(var c=b.element[0].getABox(),d=a.instancePaper.set(),e=a.entityStore.getStencilConfig(b.stencilId),f=0;f<b.indicators.length;f++)for(var g=0;g<e.indicators.length;g++)if(e.indicators[g].name===b.indicators[f].name&&e.indicators[g].iconPath.length>0){var h=5*b.labelElement[0].textContent.length,i=a.instancePaper.rect(c.bottom.x-12*(f+1)-h/2,c.bottomRight.y-14.7,12,12);i.attr({fill:'url("'+e.indicators[g].iconPath+'")',stroke:"none"}),d.push(i);var j=a.instancePaper.text(5,5,e.indicators[g].displayName).attr({fill:"#949494","font-size":10,"text-anchor":"start","font-family":"Roboto-Regular"});i.tooltip(j,P,aa),i.blink=function(){1===this.opacity?this.opacity=0:this.opacity=1,this.animate(Raphael.animation({opacity:this.opacity},400,"easeInOut",this.blink),1)},e.indicators[g].blink,i.blink(),b.indicators[f].element=i;break}}function t(){for(var b in a.entityStore.components)if(a.entityStore.components.hasOwnProperty(b)){var c=a.entityStore.getComponent(b);v(c),c.indicators=[]}}function u(a){a&&(v(a),a.indicators=[])}function v(a){for(var b=0;b<a.indicators.length;b++)a.indicators[b].element&&(a.indicators[b].element.remove(),delete a.indicators[b].element)}function w(a,b){if(a){for(var c=0;c<a.indicators.length;c++)if(a.indicators[c].name===b)return!0;return!1}}function z(a,b){a&&!w(a,b)&&(v(a),a.indicators.push({name:b}),s(a))}function A(a,b){if(a){v(a);for(var c=0;c<a.indicators.length;c++)if(a.indicators[c].name===b){a.indicators.splice(c,1);break}s(a)}}function B(a,b){w(a,b)?A(a,b):z(a,b)}function C(b){var c=this.getABox(),d=a.entityStore.getStencilConfig(b.stencilId);if(this.aniOptions={duration:300,easing:"backOut"},this.connectingPoints){for(var e=this.connectingPoints,f=0;f<Q.length;f++){var g=Q[f];e[g].attr({cx:c[g].x,cy:c[g].y})}e.set.toFront()}else{for(var e={set:this.paper.set()},f=0;f<Q.length;f++){var g=Q[f];e.set.push(e[g]=J(g,c,this)),e[g].set=e.set}e.set.hide().style("base","connectorDots",this.aniOptions).toFront(),this.mouseover(function(){for(var c=0,f=0;f<d.outboundConnectorConfigs.length;f++)c+=d.outboundConnectorConfigs[f].maxCount;(b.inboundConnections.length<d.inboundConnectorConfigs.maxCount||b.outboundConnections.length<c)&&a.editMode&&e.set.show().style("show")}),this.mouseout(function(){e.set.style("base")}),this.drag(function(){e.set.hide()},function(){e.set.hide()},function(){e.set.show()}),e.set.mouseover(function(){this.set.attr({cursor:"initial"});for(var c=0,e=0;e<d.outboundConnectorConfigs.length;e++)c+=d.outboundConnectorConfigs[e].maxCount;(b.inboundConnections.length<d.inboundConnectorConfigs.maxCount||b.outboundConnections.length<c)&&a.editMode&&(O={connectionPoint:this,component:b},this.set.style("show"),this.style("over"),this.set.attr({cursor:"crosshair"}))}),e.set.mouseout(function(){O=null,this.set.style("base")}),D(e,b),this.connectingPoints=e}return this}function D(b,c){var d,e,f,g,h=b.set,i=a.entityStore.getStencilConfig(c.stencilId),j=function(){E(c),d="M "+this.attrs.cx+","+this.attrs.cy+" L ";for(var a=0,b=0;b<i.outboundConnectorConfigs.length;b++)a+=i.outboundConnectorConfigs[b].maxCount;f=c.outboundConnections.length===a},k=function(a,b){if(!f){e&&e.remove();var c,g,i=n();O&&O.connectionPoint.set!==h?(c=O.connectionPoint.attrs.cx,g=O.connectionPoint.attrs.cy):(c=this.attrs.cx+a*i,g=this.attrs.cy+b*i);var j=d+" "+c+","+g;e=this.paper.path(j),e.attr({"stroke-width":1.6,stroke:"#dddddd"}),this.style("connecting")}},l=function(){if(!f){if(e&&e.remove(),O&&O.connectionPoint.set!==h&&!(g=O.component.inboundConnections.length===a.entityStore.getStencilConfig(O.component.stencilId).inboundConnectorConfigs.maxCount)){var b=a.util.createConnection(c.id,this.placement,O.component.id,O.connectionPoint.placement);a.entityStore.addConnection(b)}this.style("base")}};h.mousedown(function(a){a.stopPropagation()}),h.drag(k,j,l)}function E(a){G(),I(a)}function F(){H();for(var b in ba.components)if(ba.components.hasOwnProperty(b)){var c=ba.components[b];a.entityStore.removeComponent(c)}for(var d in ba.connections)ba.connections.hasOwnProperty(d)&&a.entityStore.removeConnection(ba.connections[d]);ba.components={},ba.connections={}}function G(){_&&(_.remove(),_=null),H(),ba.components={},ba.connections={}}function H(){for(var a in ba.components)ba.components.hasOwnProperty(a)&&ba.components[a].element.glowEffect.remove();for(var b in ba.connections)ba.connections.hasOwnProperty(b)&&ba.connections[b].element.glowEffect.remove()}function I(a){"component"===a.type?ba.components[a.id]=a:"connection"===a.type&&(ba.connections[a.id]=a),a.element.glowEffect=a.element.glow({width:10,fill:!0,color:"#DDDDDD"})}function J(b,c,d){var e=a.instancePaper.circle(1,1,3).attr({cx:c[b].x,cy:c[b].y});return e.placement=b,e}function K(a,b,c,d,e){var f=a.path(b).attr({stroke:"none",fill:"none"}),g=a.path(f.getSubpath(0,1)).attr(d),h=f.getTotalLength(f),i=(f.getPointAtLength(0),(new Date).getTime()),j=g,k=setInterval(function(){var a=(new Date).getTime()-i,b=a/c*h,j=f.getSubpath(0,b);d.path=j,g.animate(d,50),a>=c&&(clearInterval(k),void 0!=e&&e(),f.remove())},50);return j}function L(b,c){var d=a.entityStore.getComponent(b.fromComponentId).element[0].connectingPoints[b.fromPlacement],e=a.entityStore.getComponent(b.toComponentId).element[0].connectingPoints[b.toPlacement];b.element&&b.element.remove&&b.element.remove(),b.labelElement&&b.labelElement.remove&&b.labelElement.remove(),b.labelBackgroundElement&&b.labelBackgroundElement.remove&&b.labelBackgroundElement.remove();var f="";f+="M "+d.attrs.cx+","+d.attrs.cy+" ",f+=" L "+e.attrs.cx+","+e.attrs.cy+" ";var g;c?g=K(a.instancePaper,f,Z,{},function(){g.attr({"arrow-end":"classic-wide-long"})}):(g=a.instancePaper.path(f),g.attr({"arrow-end":"classic-wide-long"}));for(var h,i=a.entityStore.getComponent(b.fromComponentId),j=a.entityStore.getStencilConfig(i.stencilId),k=a.entityStore.getStencilConfig(j.id).outboundConnectorConfigs,l=0;l<k.length;l++)if(b.connectionType===k[l].type){h=k[l];break}g.attr({"stroke-width":1.6,stroke:h.color?h.color:"#A9A8B2",cursor:"pointer"});var m=b.label?b.label:h.defaultLabel?h.defaultLabel:null;if(m){var n=5.5*m.length;if(b.labelElement=a.instancePaper.text((d.attrs.cx+e.attrs.cx)/2-n/2+2,(d.attrs.cy+e.attrs.cy)/2,m).attr({fill:h.color?h.color:"#888","font-size":10,"text-anchor":"start","font-family":"Roboto-Regular",cursor:"pointer"}),b.labelBackgroundElement=a.instancePaper.rect((d.attrs.cx+e.attrs.cx)/2-n/2-1,(d.attrs.cy+e.attrs.cy)/2-5,n,10).attr({fill:"#F9F9F9",opacity:.9,stroke:"none",cursor:"pointer"}),b.labelElement.toFront(),b.labelElement.mouseup(function(c){E(b),a.eventAPI.getFunction(a.eventAPI.EVT_CON_CLICK)(b),3===c.which&&r(b,c)}),b.labelBackgroundElement.mouseup(function(c){E(b),a.eventAPI.getFunction(a.eventAPI.EVT_CON_CLICK)(b),3===c.which&&r(b,c)}),c){b.labelBackgroundElement.attr({opacity:0});var o=Raphael.animation({opacity:.9},0);b.labelBackgroundElement.animate(o.delay(Z/2)),b.labelElement.attr({opacity:0});var o=Raphael.animation({opacity:1},0);b.labelElement.animate(o.delay(Z/2))}}return b.element=g,g.mouseup(function(c){E(b),a.eventAPI.getFunction(a.eventAPI.EVT_CON_CLICK)(b),3===c.which&&r(b,c)}),g}function M(a,b){for(var c=0;c<a.inboundConnections.length;c++)L(a.inboundConnections[c],b);for(var c=0;c<a.outboundConnections.length;c++)L(a.outboundConnections[c],b)}function N(a,b,c){var d={};return d=c?{x:b.startingX,y:b.startingY}:{x:b.endingX,y:b.endingY},a.element.attr(d),p(a,a.element[0]),d}var O,P=$("#"+b).html(""),Q=["top","left","right","bottom","topLeft","topRight","bottomLeft","bottomRight"],R=a.editMode?170:0,S=30,T=P.height()-S-4,U=P.width()-R-4,V=36,W=V,X="easeInOut",Y=100,Z=500,_=null,aa={usableMarginWidth:a.usableMargin,x:0,y:0,width:U,height:T},ba={components:{},connections:{}},ca=[];return function(){e(),a.editMode&&(this.toolboxContainer=f(),i(this.toolboxContainer)),menubarContainer=g(),this.worspaceContainer=h(),j(menubarContainer),k(this.worspaceContainer),P.bind("contextmenu",function(a){return!1}),this.worspaceContainer.bind("mousedown",function(a){G()}),d()}(),{deselectAll:function(){G()},drawComponent:function(a){return o(a)},eraseComponent:function(a){a.labelElement.remove(),a.element[0].connectingPoints.set.remove(),a.element.remove()},drawComponentMovement:function(a,b,c){return N(a,b,c)},drawConnector:function(a,b){return L(a,b)},drawConnectors:function(a,b){return M(a,b)},eraseConnector:function(a){G(),a.element.remove(),a.labelElement&&(a.labelElement.remove(),a.labelBackgroundElement.remove())},addIndicator:function(a,b){z(a,b)},removeIndicator:function(a,b){A(a,b)},removeIndicators:function(a){u(a)},clearAllIndicators:function(){t()},toggleIndicator:function(a,b){B(a,b)},deleteSelection:function(){F()},blockUI:function(){},unblockUI:function(){},drawComponentLabel:function(a){p(a,a.element[0])},getMenu:function(b){return b?$.extend(!0,[],a.editModeMenuItems):$.extend(!0,[],a.observerModeMenuItems)},setMenu:function(b,c){b?a.editModeMenuItems=c:a.observerModeMenuItems=c,j(menubarContainer)},addMenuItem:function(b,c){b?a.editModeMenuItems.push(c):a.observerModeMenuItems.push(c),j(menubarContainer)},showGrid:function(a){l(a)},hideGrid:function(){m()}}}}(Metatron),function(a){a.Util=function(a){return{isWithinEl:function(a,b){var c=a.getABox(),d=b.getABox();return d.topLeft.x>c.topLeft.x&&d.topRight.x<c.topRight.x&&d.topLeft.y>c.topLeft.y&&d.bottomLeft.y<c.bottomLeft.y},checkColision:function(a,b){var c=a.getABox(),d=b.getABox();return!(c.left.x>=d.right.x||c.right.x<=d.left.x||c.top.y>=d.bottom.y||c.bottom.y<=d.top.y)},createComponent:function(a,b,c){return{stencilId:a.id,displayName:a.name,indicators:[],inboundConnections:[],outboundConnections:[],position:{x:b,y:c}}},createConnection:function(b,c,d,e){for(var f={fromComponentId:b,fromPlacement:c,toComponentId:d,toPlacement:e},g=a.entityStore.getComponent(f.fromComponentId),h=a.entityStore.getStencilConfig(g.stencilId),i=a.entityStore.getStencilConfig(h.id).outboundConnectorConfigs,j={},k=0;k<g.outboundConnections.length;k++)j[g.outboundConnections[k].connectionType]||(j[g.outboundConnections[k].connectionType]=0),j[g.outboundConnections[k].connectionType]++;for(var k=0;k<i.length;k++)if(!j[i[k].type]||j[i[k].type]<i[k].maxCount){f.connectionType=i[k].type;break}return f},alignCoordinateToGrid:function(b){return Math.round(b/a.gridSpacing)*a.gridSpacing}}}}(Metatron),Raphael.el.is=function(a){return this.type===(""+a).toLowerCase()},Raphael.el.x=function(){return this.is("circle")?this.attr("cx"):this.attr("x")},Raphael.el.y=function(){return this.is("circle")?this.attr("cy"):this.attr("y")},Raphael.el.o=function(){return this.ox=this.x(),this.oy=this.y(),this},Raphael.el.getABox=function(){var a=this.getBBox(),b={x:a.x,y:a.y,width:a.width,height:a.height,xLeft:a.x,xCenter:a.x+a.width/2,xRight:a.x+a.width,yTop:a.y,yMiddle:a.y+a.height/2,yBottom:a.y+a.height};return b.center={x:b.xCenter,y:b.yMiddle},b.topLeft={x:b.xLeft,
y:b.yTop},b.topRight={x:b.xRight,y:b.yTop},b.bottomLeft={x:b.xLeft,y:b.yBottom},b.bottomRight={x:b.xRight,y:b.yBottom},b.top={x:b.xCenter,y:b.yTop},b.bottom={x:b.xCenter,y:b.yBottom},b.left={x:b.xLeft,y:b.yMiddle},b.right={x:b.xRight,y:b.yMiddle},b.offset=$(this.paper.canvas).parent().offset(),b},Raphael.el.style=function(a,b,c){return this.class||(this.class=b||"default",this.aniOptions=c||null,this.mouseover(function(){this.style("hover")}),this.mouseout(function(){this.style("base")}),this.mousedown(function(){this.style("mousedown")}),this.mouseup(function(){this.style("hover")})),b=this.class?this.class:b,a=a||"base",c=this.aniOptions?this.aniOptions:null,c?this.animate(Raphael.styles[this.type][b][a],c.duration,c.easing):this.attr(Raphael.styles[this.type][b][a]),this},Raphael.st.style=function(a,b,c){for(var d=0,e=this.items.length;d<e;d++){this.items[d].style(a,b,c)}return this},Raphael.st.remove=function(){for(var a=0,b=this.items.length;a<b;a++){this.items[a].remove()}},Raphael.setStyles=function(a){Raphael.styles=$.extend(!0,{},a)},Raphael.setStyles({circle:{connectorDots:{base:{r:5,fill:"#fff",stroke:"#666","stroke-width":1,opacity:0},show:{opacity:.4},over:{cursor:"move",r:14,fill:"#ddd",opacity:1},hover:{cursor:"move"},connecting:{r:7,fill:"#ffff00",opacity:.4}}}}),Raphael.el.tooltip=function(a,b,c){return this.tp=a,this.currentlyAdjustedVBX=0,this.currentlyAdjustedVBY=0,this.tp.ox=b.offset().left+14,this.tp.oy=b.offset().top+14,this.tp.hide(),this.hover(function(a){this.mousemove(function(a){this.currentlyAdjustedVBX!==c.x||this.currentlyAdjustedVBY!==c.y?(this.tp.translate(a.clientX-this.tp.ox-this.currentlyAdjustedVBX+c.x,a.clientY-this.tp.oy-this.currentlyAdjustedVBY+c.y),this.currentlyAdjustedVBX=c.x,this.currentlyAdjustedVBY=c.y):this.tp.translate(a.clientX-this.tp.ox,a.clientY-this.tp.oy),this.tp.ox=a.clientX,this.tp.oy=a.clientY}),this.tp.show().toFront()},function(a){this.tp.hide(),this.unmousemove()}),this};